ä»kubernetes 1.24å¼€å§‹ï¼Œdockershimå·²ç»ä»kubeletä¸­ç§»é™¤ï¼Œä½†å› ä¸ºå†å²é—®é¢˜dockerå´ä¸æ”¯æŒkubernetesä¸»æ¨çš„CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰æ ‡å‡†ï¼Œ
æ‰€ä»¥dockerä¸èƒ½å†ä½œä¸ºkubernetesçš„å®¹å™¨è¿è¡Œæ—¶äº†ï¼Œå³ä»kubernetesv1.24å¼€å§‹ä¸å†ä½¿ç”¨dockeräº†ã€‚

ä½†æ˜¯å¦‚æœæƒ³ç»§ç»­ä½¿ç”¨dockerçš„è¯ï¼Œå¯ä»¥åœ¨kubeletå’Œdockerä¹‹é—´åŠ ä¸Šä¸€ä¸ªä¸­é—´å±‚cri-dockerã€‚cri-dockeræ˜¯ä¸€ä¸ªæ”¯æŒCRIæ ‡å‡†çš„shimï¼ˆå«ç‰‡ï¼‰ã€‚
ä¸€å¤´é€šè¿‡CRIè·Ÿkubeletäº¤äº’ï¼Œå¦ä¸€å¤´è·Ÿdocker apiäº¤äº’ï¼Œä»è€Œé—´æ¥çš„å®ç°äº†kubernetesä»¥dockerä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚
ä½†æ˜¯è¿™ç§æ¶æ„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè°ƒç”¨é“¾æ›´é•¿ï¼Œæ•ˆç‡æ›´ä½

æ¨èä½¿ç”¨containerdä½œä¸ºkubernetesçš„å®¹å™¨è¿è¡Œæ—¶

æˆ–è€…å¯ä»¥ç”¨å…¶ä»–è¿è¡Œæ—¶ï¼š
    Other options include using a different driver, using an older version of Kubernetes --kubernetes-version, or using a different container runtime --container-runtime.

1. å…ˆå®‰è£…docker
2. åœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£…cri-docker
    åˆ°ä¸‹é¢çš„é“¾æ¥ä¸‹è½½æœ€æ–°ç‰ˆcri-docker
    https://github.com/Mirantis/cri-dockerd/tags

    ç°åœ¨åº”è¯¥æ˜¯ä¸€ä¸ª rpmåŒ…ï¼š
        rpm -ivh cri-dockerd-0.2.5-3.el8.x86_64.rpm

3. è®¾ç½®ç³»ç»Ÿå‚æ•°
    cat <<EOF > /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-ip6tables = 1
    net.bridge.bridge-nf-call-iptables = 1
    net.ipv4.ip_forward = 1
    EOF

    sysctl -p /etc/sysctl.d/k8s.conf

4.åˆ›å»ºcri-dockerå¯åŠ¨æ–‡ä»¶ <ä½¿ç”¨rpmå®‰è£…çš„ï¼Œè¿™ä¸ªå·²ç»æœ‰äº†>
    å¯åŠ¨æ–‡ä»¶ä»ä¸‹é¢é“¾æ¥æ‰¾åˆ°ã€‚
    https://github.com/Mirantis/cri-dockerd/tree/master/packaging/systemd
    åˆ›å»ºcri-dockerå¯åŠ¨æ–‡ä»¶

    cat /usr/lib/systemd/system/cri-docker.service

    [Unit]
    Description=CRI Interface for Docker Application Container Engine
    Documentation=https://docs.mirantis.com
    After=network-online.target firewalld.service docker.service
    Wants=network-online.target
    Requires=cri-docker.socket

    [Service]
    Type=notify
    ExecStart=/usr/bin/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7
    ExecReload=/bin/kill -s HUP $MAINPID
    TimeoutSec=0
    RestartSec=2
    Restart=always

    StartLimitBurst=3

    StartLimitInterval=60s

    LimitNOFILE=infinity
    LimitNPROC=infinity
    LimitCORE=infinity

    TasksMax=infinity
    Delegate=yes
    KillMode=process

    [Install]
    WantedBy=multi-user.target

    è¿™é‡Œ/usr/bin/cri-dockerdä¸€å®šè¦åŠ ä¸Šå‚æ•°
    â€“pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7
    ç”¨æ¥æŒ‡å®šæ‰€ç”¨çš„pauseé•œåƒæ˜¯å“ªä¸ªï¼Œå¦åˆ™é»˜è®¤æ‹‰å–k8s.gcr.io/pause:3.6ï¼Œä¼šå¯¼è‡´å®‰è£…å¤±è´¥



    cat /usr/lib/systemd/system/cri-docker.socket

    [Unit]
    Description=CRI Docker Socket for the API
    PartOf=cri-docker.service

    [Socket]
    ListenStream=%t/cri-dockerd.sock
    SocketMode=0660
    SocketUser=root
    SocketGroup=docker

    [Install]
    WantedBy=sockets.target


    è®¾ç½®å¼€æœºå¯åŠ¨ï¼š
        systemctl daemon-reload
        systemctl enable cri-docker
        systemctl enable cri-docker.service
        systemctl enable --now cri-docker.socket


        systemctl is-active cri-docker



å®‰è£…å¦‚æœæŠ¥é”™ï¼š
    [minikube@VM-4-3-centos ~]$ minikube start --vm-driver=docker --base-image="anjone/kicbase" --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers'
    ğŸ˜„  minikube v1.26.1 on Centos 8.2.2004 (amd64)
    âœ¨  Using the docker driver based on existing profile
    ğŸ‘  Starting control plane node minikube in cluster minikube
    ğŸšœ  Pulling base image ...
    ğŸ¤·  docker "minikube" container is missing, will recreate.
    ğŸ”¥  Creating docker container (CPUs=2, Memory=2200MB) ...

    âŒ  Exiting due to RT_DOCKER_MISSING_CRI_DOCKER_NONE: sudo systemctl enable cri-docker.socket: Process exited with status 1
    stdout:

    stderr:
    Failed to enable unit: Unit file cri-docker.socket does not exist.

    ğŸ’¡  Suggestion: Using Kubernetes v1.24+ with the Docker runtime requires cri-docker to be installed
    ğŸ“˜  Documentation: https://minikube.sigs.k8s.io/docs/reference/drivers/none
    ğŸ¿  Related issue: https://github.com/kubernetes/minikube/issues/14410


    æ‰§è¡Œï¼š
        sudo systemctl enable cri-docker.socket   å¯ä»¥ç»™å½“å‰ç”¨æˆ·å¢åŠ sudoæƒé™ï¼Œè¦ä¹ˆå¹²è„†è®©å½“å‰ç”¨æˆ·å»å¯åŠ¨dockeréƒ½å¯ä»¥



 å¯åŠ¨æ–¹å¼å¯ä»¥æ˜¯ï¼š

       é€šè¿‡ pså‘½ä»¤æ‰¾åˆ° containerd-shimï¼Œä¹Ÿå°±æ˜¯criçš„sockåœ°å€

       [minikube@VM-4-3-centos ~]$ ps -ef |grep sock
       root       42620       1  0 17:49 ?        00:00:01 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
       root       56183       1  0 18:26 ?        00:00:00 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 0b05c54cb7452dd251941538cd6ded17561cdb91f2bf983a43755a8eb10d40cb -address /run/containerd/containerd.sock
       root       57175   56203  0 18:27 ?        00:00:00 /usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --default-ulimit=nofile=1048576:1048576 --tlsverify --tlscacert /etc/docker/ca.pem --tlscert /etc/docker/server.pem --tlskey /etc/docker/server-key.pem --label provider=docker --insecure-registry 10.96.0.0/12

       å¾—åˆ°ï¼š -address /run/containerd/containerd.sock

        --cri-socket='/run/containerd/containerd.sock'

       å¾—åˆ°å¯åŠ¨å‘½ä»¤ï¼š
        å…·ä½“çš„å¯åŠ¨å¯ä»¥è·Ÿçš„å‚æ•°å¯ä»¥æ ¹æ®  minikube start --help æ¥æŸ¥çœ‹

        minikube start --driver='docker' --container-runtime='docker' --cri-socket='/run/containerd/containerd.sock' --base-image="anjone/kicbase" --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers'


        æŠ¥é”™ï¼š
            Unfortunately, an error has occurred:
                    timed out waiting for the condition

            This error is likely caused by:
                    - The kubelet is not running
                    - The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled)

            If you are on a systemd-powered system, you can try to troubleshoot the error with the following commands:
                    - 'systemctl status kubelet'
                    - 'journalctl -xeu kubelet'

            Additionally, a control plane component may have crashed or exited when started by the container runtime.
            To troubleshoot, list all containers using your preferred container runtimes CLI.
            Here is one example how you may list all running Kubernetes containers by using crictl:
                    - 'crictl --runtime-endpoint unix:///run/containerd/containerd.sock ps -a | grep kube | grep -v pause'
                    Once you have found the failing container, you can inspect its logs with:
                    - 'crictl --runtime-endpoint unix:///run/containerd/containerd.sock logs CONTAINERID'


            è§£å†³ï¼š
                echo "KUBELET_EXTRA_ARGS=--fail-swap-on=false" > /etc/sysconfig/kubelet